services:


  glances:
    container_name: glances
    image: nicolargo/glances:latest
    environment:
      - GLANCES_OPT=-w
      - TZ=${TZ}
    ports:
      - "61208:61208"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - frontend-net
    restart: unless-stopped
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.glances.rule=Host(`glances.${HOSTDOMAIN}`)"
      - "traefik.http.routers.glances.entrypoints=websecure"
      - "traefik.http.routers.glances.tls=true"
      - "traefik.http.routers.glances.tls.certresolver=cloudflare"
      - "traefik.http.services.glances.loadbalancer.server.port=61208"
      # --- Homepage Discovery ---
      - "homepage.group=Monitoring"
      - "homepage.name=Glances"
      - "homepage.icon=glances.png"
      - "homepage.href=https://glances.${HOSTDOMAIN}"
      - "homepage.description=System Monitor"
      # Widget disabled (avoids Homepage widget rendering errors)

  leader:
    container_name: cribl_leader
    hostname: cribl_leader
    image: cribl/cribl:latest
    environment:
      - CRIBL_DIST_MODE=master
      - CRIBL_VOLUME_DIR=/opt/cribl/config-volume
      - TZ=${TZ}
    ports:
      - "4200:4200"
    volumes:
      - ${STORAGE_LOCATION}/cribl-leader:/opt/cribl/config-volume
    networks:
      - app-monitoring-net
      - frontend-net
    restart: unless-stopped
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.cribl.rule=Host(`cribl.${HOSTDOMAIN}`)"
      - "traefik.http.routers.cribl.entrypoints=websecure" # Use 443
      - "traefik.http.routers.cribl.tls=true"
      - "traefik.http.routers.cribl.tls.certresolver=cloudflare" 
      - "traefik.http.services.cribl.loadbalancer.server.port=4200"
      # --- Homepage Discovery ---
      - "homepage.group=Monitoring"
      - "homepage.name=Cribl"
      - "homepage.icon=cribl.png"
      - "homepage.href=https://cribl.${HOSTDOMAIN}"
      - "homepage.description=Cribl Logging"
      
  workers:
    container_name: cribl_worker
    hostname: cribl_worker
    image: cribl/cribl:latest
    depends_on: 
      - leader
    environment:
      - CRIBL_DIST_MODE=worker
      - CRIBL_DIST_LEADER_URL=${LEADER_URL}
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log/journal:/var/log/journal:ro
      - /:/rootfs:ro
    ports:
      - 8088:8088
      - 5514:5514/udp
      - 5514:5514/tcp
      - 6514:6514/udp
      - 6514:6514/tcp
    networks:
      - app-monitoring-net
    restart: unless-stopped
    

networks:
  app-monitoring-net:
    name: app-monitoring-net
  frontend-net:
    external: true
