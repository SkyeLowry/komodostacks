services:
  plex:
    image: plexinc/pms-docker:latest
    container_name: plex
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - ADVERTISE_IP=${PLEX_ADVERTISE_IP}
    volumes:
      - ${STORAGE_LOCATION}/plex-config:/config
      - ${STORAGE_LOCATION}/logs/plex:/config/Library/Application Support/Plex Media Server/Logs
      - ${MEDIA_LOCATION}/Plex:/Plex
      - ${STORAGE_LOCATION}/plex-transcode:/transcode
    ports:
      - 192.168.2.11:32400:32400/tcp
      #- 1900:1900/udp #Access to Plex DLNA Server
      #- 5353:5353/udp #older Bonjour/Avahi network discovery
      - 192.168.2.11:32410:32410/udp #GDM Plex Network Discovery
      - 192.168.2.11:32412:32412/udp #GDM Plex Network Discovery
      - 192.168.2.11:32413:32413/udp #GDM Plex Network Discovery
      - 192.168.2.11:32414:32414/udp #GDM Plex Network Discovery
      - 192.168.2.11:32469:32469/tcp #Access to Plex DLNA Server
    networks:
      - frontend-net
    #network_mode: "service:gluetun"
    devices:
      - /dev/dri/renderD128:/dev/dri/renderD128
    restart: unless-stopped
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.plex.rule=Host(`plex.${HOSTDOMAIN}`)"
      - "traefik.http.routers.plex.entrypoints=websecure" # Use 443
      - "traefik.http.routers.plex.tls=true"
      - "traefik.http.routers.plex.tls.certresolver=cloudflare" 
      - "traefik.http.services.plex.loadbalancer.server.port=32400"
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Plex"
      - "homepage.icon=plex.png"
      - "homepage.href=https://plex.${HOSTDOMAIN}"
      - "homepage.description=Plex Media Library"
      # --- Homepage Widget ---
      - "homepage.widget.type=plex"
      - "homepage.widget.url=http://plex:32400"
      - "homepage.widget.key=${PLEX_TOKEN}"


  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${STORAGE_LOCATION}/sonarr-config:/config
      - ${STORAGE_LOCATION}/logs/sonarr:/config/logs
      - ${MEDIA_LOCATION}/deluge-downloads:/downloads
      - ${MEDIA_LOCATION}/Plex:/Plex
    networks:
      - frontend-net
    #ports:
      #- 8989:8989
    restart: 'unless-stopped'
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.${HOSTDOMAIN}`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure" # Use 443
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.routers.sonarr.tls.certresolver=cloudflare" 
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Sonarr"
      - "homepage.icon=sonarr.png"
      - "homepage.href=https://sonarr.${HOSTDOMAIN}"
      - "homepage.description=Media Library - TV Shows"
      # --- Homepage Widget ---
      - "homepage.widget.type=sonarr"
      - "homepage.widget.url=http://sonarr:8989"
      - "homepage.widget.key=${SONARR_API_KEY}"
      - "homepage.widget.enableQueue=true"


  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${STORAGE_LOCATION}/radarr-config:/config
      - ${STORAGE_LOCATION}/logs/radarr:/config/logs
      - ${MEDIA_LOCATION}/deluge-downloads:/downloads
      - ${MEDIA_LOCATION}/Plex:/Plex
    #ports:
      #- 7878:7878
    networks:
      - frontend-net
    restart: 'unless-stopped'
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`radarr.${HOSTDOMAIN}`)"
      - "traefik.http.routers.radarr.entrypoints=websecure" # Use 443
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.routers.radarr.tls.certresolver=cloudflare" 
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Radarr"
      - "homepage.icon=radarr.png"
      - "homepage.href=https://radarr.${HOSTDOMAIN}"
      - "homepage.description=Media Library - Movies"
      # --- Homepage Widget ---
      - "homepage.widget.type=radarr"
      - "homepage.widget.url=http://radarr:7878"
      - "homepage.widget.key=${RADARR_API_KEY}"
      - "homepage.widget.enableQueue=true"

  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${STORAGE_LOCATION}/prowlarr-config:/config
      - ${STORAGE_LOCATION}/logs/prowlarr:/config/logs
    #ports:
      #- 9696:9696
    networks:
      - frontend-net
    restart: 'unless-stopped'
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.${HOSTDOMAIN}`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure" # Use 443
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.tls.certresolver=cloudflare" 
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Prowlarr"
      - "homepage.icon=prowlarr.png"
      - "homepage.href=https://prowlarr.${HOSTDOMAIN}"
      - "homepage.description=Media Library - Torrent Index"
      # --- Homepage Widget ---
      - "homepage.widget.type=prowlarr"
      - "homepage.widget.url=http://prowlarr:9696"
      - "homepage.widget.key=${PROWLARR_API_KEY}"


  nginx:
    image: nginx:latest
    container_name: nginx
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${STORAGE_LOCATION}/nginx-config:/etc/nginx
    networks:
      - frontend-net
    restart: 'unless-stopped'




  qbittorrent:
    image: qbittorrentofficial/qbittorrent-nox:latest
    container_name: qbittorrent
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - QBT_LEGAL_NOTICE=
      - QBT_TORRENTING_PORT=34524
      - QBT_WEBUI_PORT=8082
    volumes:
      - ${STORAGE_LOCATION}/qbittorrent-config:/config
      - ${STORAGE_LOCATION}/logs/radarr:/config/qBittorrent/data/logs
      - ${MEDIA_LOCATION}/deluge-downloads:/downloads
    tmpfs:
      - /tmp
    network_mode: "service:gluetun"
    restart: unless-stopped
    labels:
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Qbittorrent"
      - "homepage.icon=qbittorrent.png"
      - "homepage.href=https://qbittorrent.${HOSTDOMAIN}"
      - "homepage.description=Torrent Downloading"
      - "homepage.widget.type=qbittorrent"
      - "homepage.widget.url=http://traefik.skyelowry.home:8082"
      - "homepage.widget.username=${QBIT_USERNAME}"
      - "homepage.widget.password=${QBIT_PASSWORD}"

  overseerr:
    image: sctx/overseerr:latest
    container_name: overseerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${STORAGE_LOCATION}/overseerr-config:/app/config
      - ${STORAGE_LOCATION}/logs/overseerr:/config/logs
    networks:
      - frontend-net
    restart: 'unless-stopped'
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.overseerr.rule=Host(`overseerr.${HOSTDOMAIN}`)"
      - "traefik.http.routers.overseerr.entrypoints=websecure" # Use 443
      - "traefik.http.routers.overseerr.tls=true"
      - "traefik.http.routers.overseerr.tls.certresolver=cloudflare" 
      - "traefik.http.services.overseerr.loadbalancer.server.port=5055"
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Overseerr"
      - "homepage.icon=overseerr.png"
      - "homepage.href=https://overseerr.${HOSTDOMAIN}"
      - "homepage.description=Media Requests"
      - "homepage.widget.type=overseerr"
      - "homepage.widget.url=http://overseerr:5055"
      - "homepage.widget.key=${OVERSEERR_API_KEY}"


  tautulli:
    image: ghcr.io/tautulli/tautulli
    container_name: tautulli
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${STORAGE_LOCATION}/tautulli-config:/config
      - ${STORAGE_LOCATION}/logs/tautulli:/config/logs
    #ports:
      #- 8181:8181
    networks:
      - frontend-net
    restart: 'unless-stopped'
    labels:
      # --- Traefik Routing ---
      - "traefik.enable=true"
      - "traefik.http.routers.tautulli.rule=Host(`tautulli.${HOSTDOMAIN}`)"
      - "traefik.http.routers.tautulli.entrypoints=websecure" # Use 443
      - "traefik.http.routers.tautulli.tls=true"
      - "traefik.http.routers.tautulli.tls.certresolver=cloudflare" 
      - "traefik.http.services.tautulli.loadbalancer.server.port=8181"
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Tautulli"
      - "homepage.icon=tautulli.png"
      - "homepage.href=https://tautulli.${HOSTDOMAIN}"
      - "homepage.description=tautulli"
      # --- Homepage Widget ---
      - "homepage.widget.type=tautulli"
      - "homepage.widget.url=http://tautulli:8181"
      - "homepage.widget.key=${TAUTULLI_API_KEY}"
      - "homepage.widget.enableUser=true"

  jellyfin:
    image: jellyfin/jellyfin
    container_name: jellyfin
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    #ports:
    #  - 8096:8096
    network_mode: "service:gluetun"
    devices:
      - /dev/dri/renderD128:/dev/dri/renderD128
      - /dev/dri/card0:/dev/dri/card0
    volumes:
      - ${STORAGE_LOCATION}/jellyfin-config:/config
      - ${STORAGE_LOCATION}/logs/jellyfin:/config/log
      - ${STORAGE_LOCATION}/jellyfin-cache:/cache
      - ${MEDIA_LOCATION}/Plex:/media
    restart: 'unless-stopped'
    labels:
      # --- Homepage Discovery ---
      - "homepage.group=Media"
      - "homepage.name=Jellyfin"
      - "homepage.icon=jellyfin.png"
      - "homepage.href=https://jellyfin.${HOSTDOMAIN}"
      - "homepage.description=Media Server"
      - "homepage.widget.type=jellyfin"
      - "homepage.widget.url=${JELLYFIN_BASEURL}"
      - "homepage.widget.key=${JELLYFIN_TOKEN}"
      - "homepage.widget.enableBlocks=true"
      - "homepage.widget.enableNowPlaying=true"

  jellyplexwatched:
    image: luigi311/jellyplex-watched:latest
    container_name: jellyplexwatched
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      DRYRUN: False
      PLEX_BASEURL: ${PLEX_ADVERTISE_IP}
      PLEX_TOKEN: ${PLEX_TOKEN}
      JELLYFIN_BASEURL: ${JELLYFIN_BASEURL}
      JELLYFIN_TOKEN: ${JELLYFIN_TOKEN}
      USER_MAPPING: ${WATCHED_USER_MAPPING}
      LIBRARY_MAPPING: ${WATCHED_LIBRARY_MAPPING}
      SYNC_FROM_PLEX_TO_JELLYFIN: ${WATCHED_SYNC_FROM_PLEX_TO_JELLYFIN}
      SYNC_FROM_PLEX_TO_PLEX: ${WATCHED_SYNC_FROM_PLEX_TO_PLEX}
      SYNC_FROM_JELLYFIN_TO_PLEX: ${WATCHED_SYNC_FROM_JELLYFIN_TO_PLEX}
      SYNC_FROM_JELLYFIN_TO_JELLYFIN: ${WATCHED_SYNC_FROM_JELLYFIN_TO_JELLYFIN}
    networks:
      - frontend-net
    restart: 'unless-stopped'
    depends_on:
      plex:
        condition: service_healthy
      jellyfin:
        condition: service_healthy


  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    privileged: true
    ports:
      - 34524:34524/tcp
      - 8096:8096/tcp #Jellyfin External and Internal
      - 8082:8082/tcp #qbittorrent
    environment:
      - VPN_SERVICE_PROVIDER=custom
      - VPN_TYPE=wireguard
      - FIREWALL_VPN_INPUT_PORTS=${FIREWALL_VPN_INPUT_PORTS}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${STORAGE_LOCATION}/gluetun-config/wg0.conf:/gluetun/wireguard/wg0.conf       # store credentials & state
    networks:
      - frontend-net
    restart: 'unless-stopped'

networks:
  app-media-net:
    name: app-media-net
  frontend-net:
    external: true
