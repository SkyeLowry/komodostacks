services:
  # --- Traefik: The Traffic Cop ---
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=frontend-net"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--providers.docker.network=frontend-net"
      - "--providers.file.filename=/dynamic/dynamic.yaml"
      # --- SSL CONFIGURATION ---
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cloudflare.acme.email=${TRAEFIK_CLOUDFLARE_EMAIL}"
      - "--certificatesresolvers.cloudflare.acme.storage=/cert/acme.json"
      # --- LOGGING
      #- "--log.level=DEBUG"             # Provides detailed SSL/ACME info
      #- "--log.filepath="               # Empty path forces logs to stdout (Komodo)
      #- "--accesslog=true"
    labels:
      - "traefik.enable=true"
      # This router handles both the API and the Dashboard UI
      - "traefik.http.routers.dashboard.rule=Host(`${TRAEFIK_HOST}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web" # Or websecure if you have SSL
                  # --- Homepage Discovery ---
      - "homepage.group=Infra"
      - "homepage.name=Traefik"
      - "homepage.icon=traefik.png"
      - "homepage.href=http://${TRAEFIK_HOST}/dashboard/"
      - "homepage.description=Traefik Dashboard"
      - "homepage.widget.type=traefik"
      - "homepage.widget.url=http://${TRAEFIK_HOST}"
    environment:
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
    ports:
      - 192.168.2.11:80:80
      - 192.168.2.11:443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${STORAGE_LOCATION}/traefik/cert:/cert # For SSL cert storage
      - /mnt/containers/stacks/proxy/dynamic.yaml:/dynamic/dynamic.yaml # For SSL cert storage
    networks:
      - frontend-net

  # --- Cloudflared: The Secure Tunnel ---
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN} # Add this to Komodo environment variables
    command: tunnel --no-autoupdate run
    networks:
      - frontend-net
    depends_on:
      - traefik
    labels:
        # --- Homepage Discovery ---
      - "homepage.group=Infra"
      - "homepage.name=Cloudflare Tunnels"
      - "homepage.icon=cloudflare.png"
      - "homepage.href=https://one.dash.cloudflare.com/${CF_ACCOUNT_ID}/overview"
      - "homepage.description=Cloudflare ZeroTrust Dashboard"
      # --- Cloudflared Widget Configuration ---
      - "homepage.widget.type=cloudflared"
      - "homepage.widget.accountid=${CF_ACCOUNT_ID}"
      - "homepage.widget.tunnelid=${CF_TUNNEL_ID}"
      - "homepage.widget.key=${CF_API_TOKEN}"

  # --- Homepage: The Dashboard ---
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    depends_on:
      - traefik
    volumes:
      - /mnt/containers/stacks/proxy/homepage-config:/app/config
      - ${STORAGE_LOCATION}/logs/homepage:/app/config/logs
      - /var/run/docker.sock:/var/run/docker.sock:ro # For service status widgets
    networks:
      - frontend-net
    #ports:
    #  - 3000:3000
    environment:
      HOMEPAGE_ALLOWED_HOSTS: "dash.${HOSTDOMAIN},dash.${HOSTDOMAIN}:3000,192.168.2.5:3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`dash.${HOSTDOMAIN}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure" # Use 443
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.routers.homepage.tls.certresolver=cloudflare" 
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"

  # --- Authentik: SSO / Identity Provider ---
  authentik-postgres:
    image: postgres:16-alpine
    container_name: authentik-postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
      POSTGRES_USER: authentik
      POSTGRES_DB: authentik
    volumes:
      - ${STORAGE_LOCATION}/authentik/postgres:/var/lib/postgresql/data
    networks:
      - frontend-net

  authentik-redis:
    image: redis:7-alpine
    container_name: authentik-redis
    restart: unless-stopped
    command: --save 60 1 --loglevel warning
    volumes:
      - ${STORAGE_LOCATION}/authentik/redis:/data
    networks:
      - frontend-net

  authentik-server:
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.10.3}
    container_name: authentik-server
    restart: unless-stopped
    command: server
    depends_on:
      - authentik-postgres
      - authentik-redis
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_EXTERNAL_URL: https://auth.${HOSTDOMAIN}
      AUTHENTIK_POSTGRESQL__HOST: authentik-postgres
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
      AUTHENTIK_REDIS__HOST: authentik-redis
    volumes:
      - ${STORAGE_LOCATION}/authentik/media:/media
      - ${STORAGE_LOCATION}/authentik/custom-templates:/templates
    networks:
      - frontend-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authentik.rule=Host(`auth.${HOSTDOMAIN}`)"
      - "traefik.http.routers.authentik.entrypoints=websecure"
      - "traefik.http.routers.authentik.tls=true"
      - "traefik.http.routers.authentik.tls.certresolver=cloudflare"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
      # --- Homepage Discovery ---
      - "homepage.group=Infra"
      - "homepage.name=Authentik"
      - "homepage.icon=authentik.png"
      - "homepage.href=https://auth.${HOSTDOMAIN}"
      - "homepage.description=SSO / Identity Provider"
      # --- Homepage Widget Configuration ---
      - "homepage.widget.type=authentik"
      - "homepage.widget.url=https://auth.${HOSTDOMAIN}"
      - "homepage.widget.key=${AUTHENTIK_HOMEPAGE_TOKEN}"

  authentik-worker:
    image: ${AUTHENTIK_IMAGE:-ghcr.io/goauthentik/server}:${AUTHENTIK_TAG:-2025.10.3}
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    depends_on:
      - authentik-postgres
      - authentik-redis
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_EXTERNAL_URL: https://auth.${HOSTDOMAIN}
      AUTHENTIK_POSTGRESQL__HOST: authentik-postgres
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRES_PASSWORD}
      AUTHENTIK_REDIS__HOST: authentik-redis
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${STORAGE_LOCATION}/authentik/media:/media
      - ${STORAGE_LOCATION}/authentik/certs:/certs
      - ${STORAGE_LOCATION}/authentik/custom-templates:/templates
    networks:
      - frontend-net

# --- Shared Network ---
networks:
  frontend-net:
    name: frontend-net # This is the "Owner" of the network
